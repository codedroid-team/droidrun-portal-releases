name: Sync APK from Private Repo

on:
  repository_dispatch:
    types: [apk-built]
  workflow_dispatch:

jobs:
  download-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Download APK from private repo
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_PAT }}
        run: |
          # Get the latest workflow run that built the APK
          WORKFLOW_RUN=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ secrets.PRIVATE_REPO_FULL_NAME }}/actions/workflows/build-and-release.yml/runs?status=success&branch=main&per_page=1" \
            --jq '.workflow_runs[0].id')

          echo "Latest workflow run: $WORKFLOW_RUN"

          # Download the artifact
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ secrets.PRIVATE_REPO_FULL_NAME }}/actions/runs/$WORKFLOW_RUN/artifacts" \
            --jq '.artifacts[] | select(.name == "app-debug") | .archive_download_url' \
            | xargs -I {} gh api {} > app-debug.zip

          # Extract the APK
          unzip -o app-debug.zip

          # Debug: List files to see what was extracted
          echo "Files after extraction:"
          ls -la

      - name: Get build timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Commit and push APK
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Find the extracted APK file
          APK_FILE=$(find . -name "*.apk" -not -path "./.git/*" | head -n 1)

          if [ -z "$APK_FILE" ]; then
            echo "Error: No APK file found!"
            exit 1
          fi

          echo "Found APK: $APK_FILE"

          # Remove old APK files
          rm -f app-debug-*.apk app-debug-latest.apk

          # Copy and rename the new APK
          cp "$APK_FILE" app-debug-${{ steps.timestamp.outputs.timestamp }}.apk
          cp "$APK_FILE" app-debug-latest.apk

          git add app-debug-*.apk
          git diff --staged --quiet || git commit -m "Update APK from private repo build [skip ci]"
          git push

      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            Latest APK build from private repository
            Build timestamp: ${{ steps.timestamp.outputs.timestamp }}

            Download: [app-debug-latest.apk](https://github.com/${{ github.repository }}/raw/main/app-debug-latest.apk)
          files: |
            app-debug-latest.apk
            app-debug-${{ steps.timestamp.outputs.timestamp }}.apk
          draft: false
          prerelease: false
