name: Sync APK from Private Repo

on:
  repository_dispatch:
    types: [apk-built]
  workflow_dispatch:

jobs:
  download-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Download and extract APK
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_PAT }}
        run: |
          # Get the workflow run ID from the dispatch payload
          WORKFLOW_RUN="${{ github.event.client_payload.run_id }}"
    
          echo "Using workflow run from trigger: $WORKFLOW_RUN"

          # Download and extract artifact to temp directory
          mkdir -p temp_apk
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ secrets.PRIVATE_REPO_FULL_NAME }}/actions/runs/$WORKFLOW_RUN/artifacts" \
            --jq '.artifacts[] | select(.name == "app-debug") | .archive_download_url' \
            | xargs -I {} gh api {} > temp_apk/app-debug.zip

          cd temp_apk
          unzip -o app-debug.zip
          ls -la

      - name: Commit and push APK
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Move the extracted APK to root
          mv temp_apk/app-debug.apk app-debug.apk
          rm -rf temp_apk

          git add app-debug.apk
          git diff --staged --quiet || git commit -m "Update app-debug.apk [skip ci]"
          git push

      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            Latest APK build from private repository

            Download: [app-debug.apk](https://github.com/${{ github.repository }}/raw/main/app-debug.apk)
          files: app-debug.apk
          draft: false
          prerelease: false
